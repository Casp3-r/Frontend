{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile - {{ user.username }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>

  <body class="bg-black text-white min-h-screen flex flex-col">
    <!-- Navbar -->
    <header class="flex items-center px-4 py-3">
      <div class="flex items-center space-x-2">
        <img
          src="{% static 'images/logo.png' %}"
          alt="Logo"
          class="h-10 w-10 rounded-full"
        />
      </div>
      <div class="flex-1 mx-4">
        {% csrf_token %}
        <form method="GET" action="{% url 'home' %}">
          <input
            type="text"
            name="q"
            placeholder="search"
            class="w-full rounded-full border px-4 py-2 bg-gray-900 text-white border-gray-700 placeholder-gray-400"
          />
        </form>
      </div>

      <!-- Icons -->
      <div
        class="flex items-center space-x-9 text-white relative"
        x-data="{ openMenu: false }"
      >
        <!-- List with dropdown -->
        <div class="relative">
          <button @click="openMenu = !openMenu">
            <i class="fa-solid fa-list text-xl cursor-pointer"></i>
          </button>
          <!-- Dropdown -->
          <div
            x-show="openMenu"
            @click.away="openMenu = false"
            class="absolute right-0 mt-2 w-40 bg-gray-800 rounded-lg shadow-lg py-2 text-sm z-50"
          >
            <a href="{% url 'tips' %}" class="block px-4 py-2 hover:bg-gray-700"
              >Tips</a
            >
            <a
              href="{% url 'about' %}"
              class="block px-4 py-2 hover:bg-gray-700"
              >About Us</a
            >
            <form action="{% url 'logout' %}" method="post" class="inline">
              {% if user.is_authenticated %}
              <!-- Show Logout button for logged-in users -->
              <form action="{% url 'logout' %}" method="post" class="inline">
                {% csrf_token %}
                <button
                  type="submit"
                  class="block px-4 py-2 hover:bg-gray-700 w-full text-left"
                >
                  <i class="fa-solid fa-right-from-bracket mr-2"></i>Logout
                </button>
              </form>
              {% else %}
              <!-- Show Login link for anonymous users -->
              <a
                href="{% url 'auth' %}"
                class="block px-4 py-2 hover:bg-gray-700"
              >
                <i class="fa-solid fa-right-to-bracket mr-2"></i>Login
              </a>
              {% endif %}
            </form>
          </div>
        </div>

        <!-- Bell (go to chat) -->
        <div class="relative">
          <a href="{% url 'chat' %}" title="View Chats">
            <i class="fa-regular fa-bell text-xl cursor-pointer"></i>
            {% if chats.exists %}
            <span
              class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"
            >
              {{ chats.count }}
            </span>
            {% endif %}
          </a>
        </div>

        <!-- User (go to profile) -->
        <a href="{% url 'profile' %}">
          <i class="fa-regular fa-user text-xl cursor-pointer"></i>
        </a>
      </div>
    </header>

    <!-- Header Section -->
    <div
      class="bg-gradient-to-r from-teal-700 to-sky-700 p-6 flex items-center gap-4 shadow-lg"
    >
      <img
        src="{% if user.profile.avatar %}{{ user.profile.avatar.url }}{% else %}https://via.placeholder.com/80{% endif %}"
        alt="User"
        class="w-16 h-16 rounded-full border-2 border-white/50"
      />
      <div id="user-details" class="space-y-1">
        <!-- Name -->
        <div>
          <label class="block text-xs text-white/50">Name</label>
          <p class="text-2xl font-bold">
            {{ user.get_full_name|default:user.username }}
          </p>
        </div>

        <!-- Registered -->
        <div>
          <label class="block text-xs text-white/50">Registered</label>
          <p class="text-sm text-white/80">{{ user.date_joined|date:"M Y" }}</p>
        </div>

        <!-- Email -->
        <div>
          <label class="block text-xs text-white/50">Email</label>
          <p class="text-sm text-white/80">{{ user.email }}</p>
        </div>

        <!-- Last Valuation -->
        <div>
          <label class="block text-xs text-white/50">Last Valuation</label>
          <p class="text-sm text-white/80">
            {{ last_valuation_date|date:"M d, Y"|default:"No valuation yet" }}
          </p>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="p-6 grid lg:grid-cols-3 gap-6 flex-1">
      <!-- Valuation (Circular Chart) -->
      <div class="bg-white/10 rounded-xl p-4 shadow-lg">
        <h2 class="font-semibold mb-3">ðŸ“Š Phone Valuation</h2>
        {% if valuation_data %}
        <canvas id="valuationChart"></canvas>
        <p class="text-center mt-2 text-sm">
          Estimated Value: â‚¦{{ valuation_data.final_value|floatformat:2 }}
        </p>
        {% else %}
        <div class="text-center py-8">
          <p class="text-gray-400 mb-4">No valuation data available</p>
          <a
            href="{% url 'home' %}#calculator"
            class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg text-sm"
          >
            Calculate Valuation
          </a>
        </div>
        {% endif %}
      </div>

      <!-- Phone Health (Bars) -->
      <div class="bg-white/10 rounded-xl p-4 shadow-lg">
        <h2 class="font-semibold mb-3">ðŸ“± Phone Health</h2>
        {% if valuation_data %}
        <div class="mb-3">
          <p class="text-sm">Battery ({{ valuation_data.health.battery }}%)</p>
          <div class="w-full bg-white/20 rounded-full h-3">
            <div
              class="bg-teal-500 h-3 rounded-full"
              style="width: {{ valuation_data.health.battery }}%"
            ></div>
          </div>
        </div>
        <div class="mb-3">
          <p class="text-sm">Screen ({{ valuation_data.health.screen }}%)</p>
          <div class="w-full bg-white/20 rounded-full h-3">
            <div
              class="bg-sky-500 h-3 rounded-full"
              style="width: {{ valuation_data.health.screen }}%"
            ></div>
          </div>
        </div>
        <div class="mb-3">
          <p class="text-sm">Speaker ({{ valuation_data.health.speaker }}%)</p>
          <div class="w-full bg-white/20 rounded-full h-3">
            <div
              class="bg-teal-400 h-3 rounded-full"
              style="width: {{ valuation_data.health.speaker }}%"
            ></div>
          </div>
        </div>
        <div>
          <p class="text-sm">Camera ({{ valuation_data.health.camera }}%)</p>
          <div class="w-full bg-white/20 rounded-full h-3">
            <div
              class="bg-sky-400 h-3 rounded-full"
              style="width: {{ valuation_data.health.camera }}%"
            ></div>
          </div>
        </div>
        {% else %}
        <div class="text-center py-8">
          <p class="text-gray-400">No health data available</p>
        </div>
        {% endif %}
      </div>

      <!-- Current Phone -->
      <div class="bg-white/10 rounded-xl p-4 shadow-lg">
        <h2 class="font-semibold mb-3">ðŸ“Œ Phone Details</h2>
        {% if valuation_data %}
        <p class="text-sm">
          Model: {{ valuation_data.brand }} {{ valuation_data.model }}
        </p>
        <p class="text-sm">Storage: {{ valuation_data.storage }}</p>
        <p class="text-sm">Battery: {{ valuation_data.health.battery }}%</p>
        <p class="text-sm">Score: {{ valuation_data.score }}/100</p>
        {% else %}
        <p class="text-sm text-gray-400">No phone details available</p>
        <a
          href="{% url 'home' %}#calculator"
          class="text-teal-400 hover:text-teal-300 text-xs mt-2 inline-block"
        >
          Calculate valuation to see details
        </a>
        {% endif %}
      </div>

      <!-- Tips -->
      <div class="bg-white/10 rounded-xl p-4 shadow-lg lg:col-span-2">
        <h2 class="font-semibold mb-3">ðŸ’¡ Tips to Improve Valuation</h2>
        {% if valuation_data and valuation_data.tips %}
        <ul class="list-disc list-inside space-y-1 text-sm">
          {% for tip in valuation_data.tips %}
          <li>{{ tip.label }} (+â‚¦{{ tip.price|floatformat:2 }})</li>
          {% endfor %}
        </ul>
        <div class="mt-3 pt-3 border-t border-white/10">
          <p class="text-sm">Total potential value increase:</p>
          <p class="text-teal-400 font-semibold">
            +â‚¦{{ tips_total|floatformat:2 }}
          </p>
        </div>
        {% else %}
        <p class="text-gray-400 py-4 text-center">
          Complete a valuation to see improvement tips
        </p>
        {% endif %}
      </div>

      <!-- Repairs -->
      <div class="bg-white/10 rounded-xl p-4 shadow-lg">
        <h2 class="font-semibold mb-3">ðŸ”§ Need Repairs?</h2>
        <p class="text-sm">Contact our certified engineer:</p>
        <p class="font-semibold">
          Engr. James â€“
          <a href="tel:+2348012345678" class="text-sky-400 hover:underline"
            >+234 801 234 5678</a
          >
        </p>
        {% if valuation_data and valuation_data.tips %}
        <div class="mt-3 pt-3 border-t border-white/10">
          <p class="text-xs text-white/60">Based on your device assessment</p>
        </div>
        {% endif %}
      </div>

      <!-- Valuation History -->
      <!-- Valuation History -->
      <div class="bg-white/10 rounded-xl p-4 shadow-lg lg:col-span-3">
        <h2 class="font-semibold mb-3">ðŸ“ˆ Valuation History</h2>
        {% if valuation_history %}
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-white/20">
                <th class="text-left py-2">Date</th>
                <th class="text-left py-2">Device</th>
                <th class="text-right py-2">Value</th>
                <th class="text-right py-2">Score</th>
                <th class="text-right py-2">Debug</th>
                <!-- Temporary column -->
              </tr>
            </thead>
            <tbody>
              {% for valuation in valuation_history %}
              <tr class="border-b border-white/10 hover:bg-white/5">
                <td class="py-2">{{ valuation.created_at|date:"M d, Y" }}</td>
                <td class="py-2">
                  {{ valuation.brand }} {{ valuation.model }} {% if
                  valuation.storage %} ({{ valuation.storage }}) {% else %}
                  (Storage not set) {% endif %}
                </td>
                <td class="text-right py-2">
                  â‚¦{{ valuation.final_value|floatformat:2 }}
                </td>
                <td class="text-right py-2">
                  <span
                    class="px-2 py-1 rounded-full text-xs {% if valuation.score >= 80 %}bg-green-500/20 text-green-400 {% elif valuation.score >= 60 %}bg-yellow-500/20 text-yellow-400 {% else %}bg-red-500/20 text-red-400{% endif %}"
                  >
                    {{ valuation.score }}/100
                  </span>
                </td>
                <td class="text-right py-2 text-xs text-gray-400">
                  ID: {{ valuation.id }}<br />
                  Has storage: {{ valuation.storage|yesno:"Yes,No" }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-gray-400 text-center py-4">No valuation history yet</p>
        {% endif %}
      </div>
    </div>

    <!-- Chart Script -->
    {% if valuation_data %}
    <script>
      document.addEventListener('DOMContentLoaded', function() {
          const ctx = document.getElementById('valuationChart').getContext('2d');
          const retainedValue = {{ valuation_data.final_value }};
          const depreciationValue = {{ valuation_data.base_value }} - retainedValue;

          new Chart(ctx, {
              type: 'doughnut',
              data: {
                  labels: ['Current Value', 'Potential Value'],
                  datasets: [{
                      data: [retainedValue, depreciationValue],
                      backgroundColor: ['#14b8a6', '#334155'],
                      borderWidth: 0,
                      hoverOffset: 8
                  }]
              },
              options: {
                  cutout: '70%',
                  plugins: {
                      legend: {
                          position: 'bottom',
                          labels: {
                              color: 'white',
                              font: { size: 12 }
                          }
                      },
                      tooltip: {
                          callbacks: {
                              label: function(context) {
                                  let label = context.label || '';
                                  if (label) {
                                      label += ': ';
                                  }
                                  label += 'â‚¦' + context.raw.toLocaleString();
                                  return label;
                              }
                          }
                      }
                  }
              }
          });
      });
    </script>
    {% endif %}
  </body>
</html>
